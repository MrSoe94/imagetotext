<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal AI OCR - Ekstrak Teks dari Gambar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script async src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        .drag-over {
            @apply bg-blue-100 border-blue-500;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .result-box {
            max-height: 400px;
            overflow-y: auto;
        }
        .api-card {
            @apply border rounded-lg p-4 cursor-pointer transition hover:shadow-lg;
        }
        .api-card.selected {
            @apply border-blue-500 bg-blue-50 shadow-md;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen py-8 px-4">
        <div class="max-w-7xl mx-auto">
            <!-- Header -->
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-gray-800 mb-2">üåê Universal AI OCR</h1>
                <p class="text-gray-600">Ekstrak Teks dengan Semua Jenis AI API</p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Left Panel -->
                <div class="lg:col-span-1">
                    <div class="bg-white rounded-lg shadow-lg p-6 sticky top-4">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">‚öôÔ∏è Pengaturan</h2>

                        <!-- AI Provider Selection -->
                        <div class="mb-6">
                            <label class="block text-sm font-semibold text-gray-700 mb-3">Pilih AI Provider:</label>
                            <div id="providerList" class="space-y-2">
                                <!-- Providers will be inserted here -->
                            </div>
                        </div>

                        <!-- API Configuration Panel -->
                        <div id="configPanel" class="space-y-4 mb-6 p-4 bg-gray-100 rounded-lg">
                            <h3 class="font-semibold text-gray-800">üîë Konfigurasi API</h3>
                            
                            <div id="configFields">
                                <!-- Config fields will be inserted dynamically -->
                            </div>

                            <button id="saveConfigBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded-lg transition">
                                üíæ Simpan Konfigurasi
                            </button>
                        </div>

                        <!-- Language Selection -->
                        <div class="mb-4">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Bahasa:</label>
                            <select id="languageSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="id">üáÆüá© Indonesia</option>
                                <option value="en">üá¨üáß English</option>
                                <option value="zh">üá®üá≥ Chinese</option>
                                <option value="ja">üáØüáµ Japanese</option>
                                <option value="ar">üá∏üá¶ Arabic</option>
                                <option value="ko">üá∞üá∑ Korean</option>
                                <option value="vi">üáªüá≥ Vietnamese</option>
                                <option value="th">üáπüá≠ Thai</option>
                            </select>
                        </div>

                        <!-- Image Upload -->
                        <div class="mb-4">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Upload Gambar:</label>
                            <div id="dropZone" class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:bg-gray-50 transition">
                                <input type="file" id="imageInput" accept="image/*" class="hidden">
                                <div class="text-gray-600">
                                    <p class="text-lg font-semibold">üì§ Drag & Drop</p>
                                    <p class="text-sm text-gray-500">atau klik upload</p>
                                </div>
                            </div>
                        </div>

                        <!-- Preprocessing Options -->
                        <div class="mb-4 p-3 bg-gray-100 rounded-lg">
                            <h4 class="font-semibold text-gray-800 mb-2 text-sm">üñºÔ∏è Preprocessing:</h4>
                            <div class="space-y-1 text-sm">
                                <label class="flex items-center">
                                    <input type="checkbox" id="autoEnhance" checked>
                                    <span class="ml-2">Auto-enhance</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="autoScale" checked>
                                    <span class="ml-2">Auto-scale</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="autoGrayscale" checked>
                                    <span class="ml-2">Grayscale</span>
                                </label>
                            </div>
                        </div>

                        <!-- Process Button -->
                        <button id="processBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition disabled:opacity-50">
                            üöÄ Ekstrak Teks
                        </button>

                        <!-- Progress -->
                        <div id="progressContainer" class="hidden mt-4">
                            <div class="flex items-center gap-2">
                                <div class="loader"></div>
                                <p class="text-sm font-semibold text-gray-700" id="progressText">Processing...</p>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                                <div id="progressBar" class="bg-blue-600 h-2 rounded-full" style="width: 0%"></div>
                            </div>
                        </div>

                        <!-- Error Message -->
                        <div id="errorMsg" class="hidden mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg text-sm"></div>
                    </div>
                </div>

                <!-- Right Panel -->
                <div class="lg:col-span-2 space-y-6">
                    <!-- Image Preview -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">üëÄ Preview</h2>
                        <canvas id="previewCanvas" class="w-full border border-gray-300 rounded-lg bg-gray-100" style="display: none; max-height: 400px;"></canvas>
                        <div id="noImageMsg" class="text-center text-gray-400 py-12">
                            <p class="text-lg">Tidak ada gambar</p>
                        </div>
                    </div>

                    <!-- Results -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">üìÑ Hasil</h2>
                        
                        <!-- Statistics -->
                        <div id="statsContainer" class="hidden grid grid-cols-3 gap-3 mb-4">
                            <div class="bg-blue-50 p-3 rounded-lg text-center">
                                <p class="text-2xl font-bold text-blue-600" id="charCount">0</p>
                                <p class="text-xs text-gray-600">Karakter</p>
                            </div>
                            <div class="bg-green-50 p-3 rounded-lg text-center">
                                <p class="text-2xl font-bold text-green-600" id="wordCount">0</p>
                                <p class="text-xs text-gray-600">Kata</p>
                            </div>
                            <div class="bg-purple-50 p-3 rounded-lg text-center">
                                <p class="text-2xl font-bold text-purple-600" id="lineCount">0</p>
                                <p class="text-xs text-gray-600">Baris</p>
                            </div>
                        </div>

                        <!-- Text Area -->
                        <textarea id="resultText" class="w-full border border-gray-300 rounded-lg p-4 h-64 font-mono text-sm result-box" placeholder="Hasil akan muncul di sini..."></textarea>

                        <!-- Confidence -->
                        <div id="confidenceContainer" class="hidden mt-3 p-2 bg-yellow-50 border border-yellow-200 rounded text-sm">
                            API: <span id="usedApi" class="font-bold text-yellow-600">-</span> | 
                            Akurasi: <span id="confidenceScore" class="font-bold text-yellow-600">0%</span>
                        </div>

                        <!-- Action Buttons -->
                        <div class="grid grid-cols-3 gap-2 mt-4">
                            <button id="copyBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 rounded-lg text-sm" disabled>üìã Copy</button>
                            <button id="downloadBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 rounded-lg text-sm" disabled>üíæ Download</button>
                            <button id="clearBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 rounded-lg text-sm">üóëÔ∏è Clear</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- API Comparison Table -->
            <div class="mt-8 bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">üìä Perbandingan AI Provider</h2>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b-2 border-gray-300">
                                <th class="text-left px-4 py-2">Provider</th>
                                <th class="text-center px-4 py-2">Akurasi</th>
                                <th class="text-center px-4 py-2">Biaya</th>
                                <th class="text-center px-4 py-2">Kecepatan</th>
                                <th class="text-center px-4 py-2">Bahasa</th>
                                <th class="text-center px-4 py-2">Offline</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="border-b border-gray-200 hover:bg-gray-50">
                                <td class="px-4 py-2 font-semibold">Tesseract.js</td>
                                <td class="text-center">75-85%</td>
                                <td class="text-center text-green-600">Gratis</td>
                                <td class="text-center">Sedang</td>
                                <td class="text-center">100+</td>
                                <td class="text-center text-green-600">‚úÖ</td>
                            </tr>
                            <tr class="border-b border-gray-200 hover:bg-gray-50">
                                <td class="px-4 py-2 font-semibold">OpenAI GPT-4o</td>
                                <td class="text-center text-green-600">95-98%</td>
                                <td class="text-center">$0.005/img</td>
                                <td class="text-center">Cepat</td>
                                <td class="text-center">Semua</td>
                                <td class="text-center text-red-600">‚ùå</td>
                            </tr>
                            <tr class="border-b border-gray-200 hover:bg-gray-50">
                                <td class="px-4 py-2 font-semibold">Google Gemini 2.5</td>
                                <td class="text-center text-green-600">94-97%</td>
                                <td class="text-center">Gratis Trial</td>
                                <td class="text-center">Cepat</td>
                                <td class="text-center">Semua</td>
                                <td class="text-center text-red-600">‚ùå</td>
                            </tr>
                            <tr class="border-b border-gray-200 hover:bg-gray-50">
                                <td class="px-4 py-2 font-semibold">Claude 3.5 Vision</td>
                                <td class="text-center text-green-600">94-96%</td>
                                <td class="text-center">$3/M token</td>
                                <td class="text-center">Cepat</td>
                                <td class="text-center">Semua</td>
                                <td class="text-center text-red-600">‚ùå</td>
                            </tr>
                            <tr class="border-b border-gray-200 hover:bg-gray-50">
                                <td class="px-4 py-2 font-semibold">Azure Computer Vision</td>
                                <td class="text-center">94-96%</td>
                                <td class="text-center">$1-5/1k</td>
                                <td class="text-center">Cepat</td>
                                <td class="text-center">Semua</td>
                                <td class="text-center text-red-600">‚ùå</td>
                            </tr>
                            <tr class="hover:bg-gray-50">
                                <td class="px-4 py-2 font-semibold">Google Cloud Vision</td>
                                <td class="text-center text-green-600">95-98%</td>
                                <td class="text-center">$1.50/1k</td>
                                <td class="text-center">Cepat</td>
                                <td class="text-center">Semua</td>
                                <td class="text-center text-red-600">‚ùå</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // AI Providers Configuration
        const providers = {
            tesseract: {
                name: 'Tesseract.js',
                icon: 'üü¢',
                accuracy: '75-85%',
                requiresKey: false,
                config: {},
                description: 'Gratis, offline, berjalan di browser'
            },
            openai: {
                name: 'OpenAI GPT-4o',
                icon: 'üü†',
                accuracy: '95-98%',
                requiresKey: true,
                config: {
                    apiKey: { label: 'API Key', type: 'password', required: true },
                    model: { label: 'Model', type: 'text', value: 'gpt-4o-mini' }
                },
                description: 'Akurasi tinggi, berbayar'
            },
            gemini: {
                name: 'Google Gemini 2.5',
                icon: 'üîµ',
                accuracy: '94-97%',
                requiresKey: true,
                config: {
                    apiKey: { label: 'API Key', type: 'password', required: true },
                    model: { label: 'Model', type: 'text', value: 'gemini-2.0-flash' }
                },
                description: 'Gratis trial, akurasi bagus'
            },
            claude: {
                name: 'Claude 3.5 Vision',
                icon: 'üü£',
                accuracy: '94-96%',
                requiresKey: true,
                config: {
                    apiKey: { label: 'API Key', type: 'password', required: true },
                    model: { label: 'Model', type: 'text', value: 'claude-3-5-sonnet-20241022' }
                },
                description: 'Akurasi tinggi, multimodal'
            },
            azure: {
                name: 'Azure Computer Vision',
                icon: 'üî¥',
                accuracy: '94-96%',
                requiresKey: true,
                config: {
                    endpoint: { label: 'Endpoint', type: 'text', required: true, placeholder: 'https://xxx.cognitiveservices.azure.com/' },
                    apiKey: { label: 'API Key', type: 'password', required: true }
                },
                description: 'Enterprise grade, akurasi tinggi'
            },
            google: {
                name: 'Google Cloud Vision',
                icon: 'üü°',
                accuracy: '95-98%',
                requiresKey: true,
                config: {
                    apiKey: { label: 'API Key', type: 'password', required: true }
                },
                description: 'Terbaik untuk OCR, berbayar'
            }
        };

        // State
        const state = {
            image: null,
            originalImage: null,
            selectedProvider: 'tesseract',
            config: {},
            isProcessing: false,
            tesseractWorker: null
        };

        // DOM Elements
        const elements = {
            providerList: document.getElementById('providerList'),
            configPanel: document.getElementById('configPanel'),
            configFields: document.getElementById('configFields'),
            saveConfigBtn: document.getElementById('saveConfigBtn'),
            languageSelect: document.getElementById('languageSelect'),
            dropZone: document.getElementById('dropZone'),
            imageInput: document.getElementById('imageInput'),
            previewCanvas: document.getElementById('previewCanvas'),
            noImageMsg: document.getElementById('noImageMsg'),
            processBtn: document.getElementById('processBtn'),
            progressContainer: document.getElementById('progressContainer'),
            progressText: document.getElementById('progressText'),
            progressBar: document.getElementById('progressBar'),
            errorMsg: document.getElementById('errorMsg'),
            resultText: document.getElementById('resultText'),
            copyBtn: document.getElementById('copyBtn'),
            downloadBtn: document.getElementById('downloadBtn'),
            clearBtn: document.getElementById('clearBtn'),
            statsContainer: document.getElementById('statsContainer'),
            charCount: document.getElementById('charCount'),
            wordCount: document.getElementById('wordCount'),
            lineCount: document.getElementById('lineCount'),
            confidenceContainer: document.getElementById('confidenceContainer'),
            confidenceScore: document.getElementById('confidenceScore'),
            usedApi: document.getElementById('usedApi'),
            autoEnhance: document.getElementById('autoEnhance'),
            autoScale: document.getElementById('autoScale'),
            autoGrayscale: document.getElementById('autoGrayscale')
        };

        // Initialize Providers
        function initializeProviders() {
            elements.providerList.innerHTML = '';
            Object.keys(providers).forEach(key => {
                const provider = providers[key];
                const card = document.createElement('div');
                card.className = `api-card ${state.selectedProvider === key ? 'selected' : ''}`;
                card.innerHTML = `
                    <div class="font-semibold text-gray-800">${provider.icon} ${provider.name}</div>
                    <div class="text-xs text-gray-600">${provider.description}</div>
                `;
                card.addEventListener('click', () => selectProvider(key));
                elements.providerList.appendChild(card);
            });
        }

        // Select Provider
        function selectProvider(providerKey) {
            state.selectedProvider = providerKey;
            loadConfig(providerKey);
            renderConfigPanel();
            initializeProviders();
        }

        // Render Config Panel
        function renderConfigPanel() {
            const provider = providers[state.selectedProvider];
            elements.configFields.innerHTML = '';

            if (provider.requiresKey) {
                Object.keys(provider.config).forEach(key => {
                    const field = provider.config[key];
                    const value = state.config[key] || field.value || '';
                    const html = `
                        <div>
                            <label class="block text-xs font-semibold text-gray-700 mb-1">${field.label}:</label>
                            <input type="${field.type}" id="config_${key}" value="${value}" placeholder="${field.placeholder || ''}" 
                                   class="w-full px-3 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                        </div>
                    `;
                    elements.configFields.insertAdjacentHTML('beforeend', html);
                });
            } else {
                elements.configFields.innerHTML = '<p class="text-xs text-gray-600">‚úÖ Tidak perlu konfigurasi (offline)</p>';
            }
        }

        // Save Config
        document.getElementById('saveConfigBtn').addEventListener('click', () => {
            const provider = providers[state.selectedProvider];
            Object.keys(provider.config).forEach(key => {
                const input = document.getElementById(`config_${key}`);
                if (input) {
                    state.config[key] = input.value;
                }
            });
            localStorage.setItem(`config_${state.selectedProvider}`, JSON.stringify(state.config));
            alert('‚úÖ Konfigurasi tersimpan!');
        });

        // Load Config
        function loadConfig(providerKey) {
            const saved = localStorage.getItem(`config_${providerKey}`);
            state.config = saved ? JSON.parse(saved) : {};
        }

        // Event Listeners
        elements.dropZone.addEventListener('click', () => elements.imageInput.click());
        elements.dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            elements.dropZone.classList.add('drag-over');
        });
        elements.dropZone.addEventListener('dragleave', () => {
            elements.dropZone.classList.remove('drag-over');
        });
        elements.dropZone.addEventListener('drop', handleDrop);
        elements.imageInput.addEventListener('change', handleImageSelect);
        elements.processBtn.addEventListener('click', processImage);
        elements.copyBtn.addEventListener('click', copyText);
        elements.downloadBtn.addEventListener('click', downloadText);
        elements.clearBtn.addEventListener('click', clearAll);

        function handleDrop(e) {
            e.preventDefault();
            elements.dropZone.classList.remove('drag-over');
            if (e.dataTransfer.files.length > 0) {
                elements.imageInput.files = e.dataTransfer.files;
                handleImageSelect();
            }
        }

        function handleImageSelect() {
            const file = elements.imageInput.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    state.originalImage = img;
                    displayPreview(img);
                    elements.processBtn.disabled = false;
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function displayPreview(img) {
            const canvas = elements.previewCanvas;
            canvas.width = img.width > 800 ? 800 : img.width;
            canvas.height = (canvas.width / img.width) * img.height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            canvas.style.display = 'block';
            elements.noImageMsg.style.display = 'none';
        }

        async function preprocessImage(img) {
            const canvas = document.createElement('canvas');
            canvas.width = img.width;
            canvas.height = img.height;
            const ctx = canvas.getContext('2d');

            if (elements.autoScale.checked && canvas.width > 2000) {
                const ratio = 2000 / canvas.width;
                canvas.width = 2000;
                canvas.height = canvas.height * ratio;
            }

            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

            if (elements.autoGrayscale.checked) {
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                for (let i = 0; i < data.length; i += 4) {
                    const gray = data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114;
                    data[i] = gray;
                    data[i + 1] = gray;
                    data[i + 2] = gray;
                }
                ctx.putImageData(imageData, 0, 0);
            }

            if (elements.autoEnhance.checked) {
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                let min = 255, max = 0;
                for (let i = 0; i < data.length; i += 4) {
                    const gray = data[i];
                    if (gray < min) min = gray;
                    if (gray > max) max = gray;
                }
                const range = max - min || 1;
                for (let i = 0; i < data.length; i += 4) {
                    const val = Math.round(((data[i] - min) / range) * 255);
                    data[i] = val;
                    data[i + 1] = val;
                    data[i + 2] = val;
                }
                ctx.putImageData(imageData, 0, 0);
            }

            return new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.95));
        }

        // Process with different providers
        async function processTesseract(blob) {
            if (!state.tesseractWorker) {
                state.tesseractWorker = await Tesseract.createWorker();
            }
            const worker = state.tesseractWorker;
            const lang = mapLanguage('tesseract');
            
            await worker.loadLanguage(lang);
            await worker.initialize(lang);

            const result = await worker.recognize(blob);
            return {
                text: result.data.text,
                confidence: Math.round(result.data.confidence)
            };
        }

        async function processOpenAI(blob) {
            const apiKey = state.config.apiKey;
            const model = state.config.model || 'gpt-4o-mini';
            if (!apiKey) throw new Error('API Key OpenAI tidak diisi');

            const base64 = await blobToBase64(blob);
            const base64Data = base64.split(',')[1];

            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: model,
                    messages: [{
                        role: 'user',
                        content: [
                            { type: 'text', text: 'Ekstrak SEMUA teks dari gambar ini. Jika ada teks, return hanya teks tanpa penjelasan apapun. Jika tidak ada teks, return "TIDAK ADA TEKS"' },
                            { type: 'image_url', image_url: { url: `data:image/jpeg;base64,${base64Data}` } }
                        ]
                    }],
                    max_tokens: 4096
                })
            });

            const data = await response.json();
            if (data.error) throw new Error(data.error.message);

            return {
                text: data.choices[0].message.content,
                confidence: 95
            };
        }

        async function processGemini(blob) {
            const apiKey = state.config.apiKey;
            const model = state.config.model || 'gemini-2.0-flash';
            if (!apiKey) throw new Error('API Key Gemini tidak diisi');

            const base64 = await blobToBase64(blob);
            const base64Data = base64.split(',')[1];

            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{
                        parts: [
                            { text: 'Ekstrak SEMUA teks dari gambar ini. Jika ada teks, return hanya teks tanpa penjelasan. Jika tidak ada, return "TIDAK ADA TEKS"' },
                            { inline_data: { mime_type: 'image/jpeg', data: base64Data } }
                        ]
                    }]
                })
            });

            const data = await response.json();
            if (data.error) throw new Error(data.error.message);

            return {
                text: data.candidates[0].content.parts[0].text,
                confidence: 95
            };
        }

        async function processClaude(blob) {
            const apiKey = state.config.apiKey;
            const model = state.config.model || 'claude-3-5-sonnet-20241022';
            if (!apiKey) throw new Error('API Key Claude tidak diisi');

            const base64 = await blobToBase64(blob);
            const base64Data = base64.split(',')[1];

            const response = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: {
                    'x-api-key': apiKey,
                    'anthropic-version': '2023-06-01',
                    'content-type': 'application/json'
                },
                body: JSON.stringify({
                    model: model,
                    max_tokens: 4096,
                    messages: [{
                        role: 'user',
                        content: [
                            { type: 'text', text: 'Ekstrak SEMUA teks dari gambar ini. Jika ada teks, return hanya teks. Jika tidak ada, return "TIDAK ADA TEKS"' },
                            { type: 'image', source: { type: 'base64', media_type: 'image/jpeg', data: base64Data } }
                        ]
                    }]
                })
            });

            const data = await response.json();
            if (data.error) throw new Error(data.error.message);

            return {
                text: data.content[0].text,
                confidence: 95
            };
        }

        async function processAzure(blob) {
            const endpoint = state.config.endpoint;
            const apiKey = state.config.apiKey;
            if (!endpoint || !apiKey) throw new Error('Endpoint atau API Key Azure tidak diisi');

            const response = await fetch(`${endpoint.replace(/\/$/, '')}/vision/v4.0/read/analyzeImage`, {
                method: 'POST',
                headers: {
                    'Ocp-Apim-Subscription-Key': apiKey,
                    'Content-Type': 'application/octet-stream'
                },
                body: blob
            });

            if (!response.ok) throw new Error('Azure API error: ' + response.statusText);

            const operationLocation = response.headers.get('Operation-Location');
            if (!operationLocation) throw new Error('No operation location returned');

            // Poll for results
            let result = null;
            for (let i = 0; i < 120; i++) {
                await new Promise(r => setTimeout(r, 500));
                const checkResponse = await fetch(operationLocation, {
                    headers: { 'Ocp-Apim-Subscription-Key': apiKey }
                });
                const checkData = await checkResponse.json();
                
                if (checkData.status === 'succeeded') {
                    result = checkData;
                    break;
                } else if (checkData.status === 'failed') {
                    throw new Error('Azure operation failed');
                }
            }

            if (!result) throw new Error('Azure operation timeout');

            const text = result.analyzeResult.readResults
                .map(page => page.lines.map(line => line.text).join('\n')).join('\n');

            return {
                text: text,
                confidence: 94
            };
        }

        async function processGoogle(blob) {
            const apiKey = state.config.apiKey;
            if (!apiKey) throw new Error('API Key Google Cloud Vision tidak diisi');

            const base64 = await blobToBase64(blob);
            const base64Data = base64.split(',')[1];

            const response = await fetch(`https://vision.googleapis.com/v1/images:annotate?key=${apiKey}`, {
                method: 'POST',
                body: JSON.stringify({
                    requests: [{
                        image: { content: base64Data },
                        features: [{ type: 'TEXT_DETECTION' }]
                    }]
                })
            });

            const data = await response.json();
            if (data.error) throw new Error(data.error.message);

            const text = data.responses[0].fullTextAnnotation?.text || '';
            return {
                text: text,
                confidence: 96
            };
        }

        function blobToBase64(blob) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.readAsDataURL(blob);
            });
        }

        function mapLanguage(provider) {
            const lang = elements.languageSelect.value;
            const langMap = {
                tesseract: { id: 'ind', en: 'eng', zh: 'chi_sim', ja: 'jpn', ar: 'ara', ko: 'kor', vi: 'vie', th: 'tha' },
                default: lang
            };
            return langMap[provider]?.[lang] || lang;
        }

        async function processImage() {
            if (!state.originalImage) {
                showError('Pilih gambar terlebih dahulu');
                return;
            }

            const provider = state.selectedProvider;

            try {
                elements.processBtn.disabled = true;
                elements.progressContainer.classList.remove('hidden');
                elements.errorMsg.classList.add('hidden');
                showProgress(0, 'Preprocessing...');

                const processedBlob = await preprocessImage(state.originalImage);
                showProgress(30, `Mengirim ke ${providers[provider].name}...`);

                let result;
                switch (provider) {
                    case 'tesseract':
                        result = await processTesseract(processedBlob);
                        break;
                    case 'openai':
                        result = await processOpenAI(processedBlob);
                        break;
                    case 'gemini':
                        result = await processGemini(processedBlob);
                        break;
                    case 'claude':
                        result = await processClaude(processedBlob);
                        break;
                    case 'azure':
                        result = await processAzure(processedBlob);
                        break;
                    case 'google':
                        result = await processGoogle(processedBlob);
                        break;
                }

                showProgress(100, 'Selesai!');

                elements.resultText.value = result.text || 'Tidak ada teks terdeteksi';
                elements.confidenceScore.textContent = result.confidence + '%';
                elements.usedApi.textContent = providers[provider].name;
                elements.confidenceContainer.classList.remove('hidden');

                updateStatistics(result.text);

                elements.copyBtn.disabled = false;
                elements.downloadBtn.disabled = false;

                setTimeout(() => {
                    elements.progressContainer.classList.add('hidden');
                }, 1000);
            } catch (error) {
                showError(error.message);
            } finally {
                elements.processBtn.disabled = false;
            }
        }

        function updateStatistics(text) {
            const chars = text.length;
            const words = text.trim() ? text.trim().split(/\s+/).length : 0;
            const lines = text.trim() ? text.trim().split('\n').length : 0;

            elements.charCount.textContent = chars;
            elements.wordCount.textContent = words;
            elements.lineCount.textContent = lines;
            elements.statsContainer.classList.remove('hidden');
        }

        function showProgress(percent, message) {
            elements.progressBar.style.width = percent + '%';
            elements.progressText.textContent = message;
        }

        function copyText() {
            elements.resultText.select();
            document.execCommand('copy');
            alert('‚úÖ Teks disalin!');
        }

        function downloadText() {
            const text = elements.resultText.value;
            const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'ocr_' + Date.now() + '.txt';
            a.click();
            URL.revokeObjectURL(url);
        }

        function clearAll() {
            elements.imageInput.value = '';
            elements.resultText.value = '';
            elements.previewCanvas.style.display = 'none';
            elements.noImageMsg.style.display = 'block';
            elements.statsContainer.classList.add('hidden');
            elements.confidenceContainer.classList.add('hidden');
            elements.progressContainer.classList.add('hidden');
            elements.copyBtn.disabled = true;
            elements.downloadBtn.disabled = true;
            elements.processBtn.disabled = true;
            elements.errorMsg.classList.add('hidden');
            state.originalImage = null;
        }

        function showError(message) {
            elements.errorMsg.textContent = '‚ùå Error: ' + message;
            elements.errorMsg.classList.remove('hidden');
            elements.progressContainer.classList.add('hidden');
        }

        // Initialize
        initializeProviders();
        renderConfigPanel();
    </script>
</body>
</html>
